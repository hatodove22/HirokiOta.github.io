'use client'

import { useState, useEffect } from 'react'
import { ThemeProvider } from 'next-themes'
import { Toaster } from './components/ui/sonner'
import { Header } from './components/header'
import { Footer } from './components/footer'
import { HomePage } from './pages/home-page'
import { AboutPage } from './pages/about-page'
import { ProjectsPage } from './pages/projects-page'
import { ProjectDetailPage } from './pages/project-detail-page'
import { PapersPage } from './pages/papers-page'
import { BlogsPage } from './pages/blogs-page'
import { BlogDetailPage } from './pages/blog-detail-page'
import { ContactPage } from './pages/contact-page'
import { EditModePage } from './pages/edit-mode-page'
import { EditProtoPage } from './pages/edit-proto-page'
import { ErrorBoundary } from './components/error-boundary'
import { Locale, defaultLocale } from './lib/types'

type HistoryState = {
  page: string
  slug: string | null
}

const VALID_PAGES = new Set([\n  'home',\n  'about',\n  'projects',\n  'project-detail',\n  'papers',\n  'blog',\n  'blog-detail',\n  'contact',\n  'edit-mode',\n  'edit-proto'\n])

const parseHistoryState = (state: Partial<HistoryState> | null | undefined): HistoryState => {
  if (!state) {
    return { page: 'home', slug: null }
  }

  let page = state.page && VALID_PAGES.has(state.page) ? state.page : 'home'
  let slug = state.slug ? state.slug : null

  if (page === 'project-detail' && !slug) {
    page = 'projects'
  }

  if (page === 'blog-detail' && !slug) {
    page = 'blog'
  }

  return { page, slug }
}

const getStateFromLocation = (): HistoryState => {
  if (typeof window === 'undefined') {
    return { page: 'home', slug: null }
  }
  const pathname = window.location.pathname
  if (pathname === '/edit' || pathname === '/edit/') {
    return { page: 'edit-proto', slug: null }
  }
  const params = new URLSearchParams(window.location.search)
  const pageParam = params.get('page')
  const slugParam = params.get('slug')
  return parseHistoryState({ page: pageParam ?? undefined, slug: slugParam ?? undefined })
}
  }

  const params = new URLSearchParams(window.location.search)
  const pageParam = params.get('page')
  const slugParam = params.get('slug')

  return parseHistoryState({
    page: pageParam ?? undefined,
    slug: slugParam ?? undefined
  })
}

const buildUrl = (page: string, slug: string | null) => {
  if (typeof window === 'undefined') {
    return undefined
  }

  const url = new URL(window.location.href)

  if (page === 'home' && !slug) {
    url.searchParams.delete('page')
    url.searchParams.delete('slug')
  } else {
    url.searchParams.set('page', page)
    if (slug) {
      url.searchParams.set('slug', slug)
    } else {
      url.searchParams.delete('slug')
    }
  }

  url.hash = ''

  return `${url.pathname}${url.search}`
}

export default function App() {
  const [currentLocale, setCurrentLocale] = useState<Locale>(defaultLocale)
  const [currentPage, setCurrentPage] = useState('home')
  const [currentSlug, setCurrentSlug] = useState<string | null>(null)
  const [mounted, setMounted] = useState(false)

  useEffect(() => {
    if (typeof window === 'undefined') {
      setMounted(true)
      return
    }

    const initialState = getStateFromLocation()
    setCurrentPage(initialState.page)
    setCurrentSlug(initialState.slug)
    const initialUrl = buildUrl(initialState.page, initialState.slug)
    if (initialUrl) {
      window.history.replaceState(initialState, '', initialUrl)
    }

    const handlePopState = (event: PopStateEvent) => {
      const state = parseHistoryState(event.state ?? getStateFromLocation())
      setCurrentPage(state.page)
      setCurrentSlug(state.slug)
    }

    window.addEventListener('popstate', handlePopState)
    setMounted(true)

    return () => {
      window.removeEventListener('popstate', handlePopState)
    }
  }, [])

  const navigate = (page: string, slug?: string) => {
    setCurrentPage(page)
    if (slug) {
      setCurrentSlug(slug)
    } else {
      setCurrentSlug(null)
    }

    const nextState: HistoryState = { page, slug: slug ?? null }
    const nextUrl = buildUrl(page, nextState.slug)

    if (typeof window !== 'undefined' && nextUrl) {
      window.history.pushState(nextState, '', nextUrl)
    }
  }

  const renderPage = () => {
  switch (currentPage) {
    case 'home':
      return <HomePage locale={currentLocale} onNavigate={navigate} />
    case 'about':
      return <AboutPage locale={currentLocale} />
    case 'projects':
      return <ProjectsPage locale={currentLocale} onNavigate={navigate} />
    case 'project-detail':
      return <ProjectDetailPage locale={currentLocale} slug={currentSlug!} onNavigate={navigate} />
    case 'papers':
      return <PapersPage locale={currentLocale} />
    case 'blog':
      return <BlogsPage locale={currentLocale} onNavigate={navigate} />
    case 'blog-detail':
      return <BlogDetailPage locale={currentLocale} slug={currentSlug!} onNavigate={navigate} />
    case 'contact':
      return <ContactPage locale={currentLocale} />
    case 'edit-mode':
      return <EditModePage />
    case 'edit-proto':
      return <EditProtoPage />
    default:
      return <HomePage locale={currentLocale} onNavigate={navigate} />
  }
}

if (!mounted) {
    return (
      <div className="size-full flex items-center justify-center">
        <div className="animate-pulse">Loading...</div>
      </div>
    )
  }

  return (
    <ThemeProvider
      attribute="class"
      defaultTheme="system"
      enableSystem
      disableTransitionOnChange
    >
      <div className="min-h-screen bg-background flex flex-col">
        <Header
          locale={currentLocale}
          currentPage={currentPage}
          onNavigate={navigate}
          onLocaleChange={setCurrentLocale}
        />

        <main className="flex-1">
          {renderPage()}
        </main>

        <Footer locale={currentLocale} onNavigate={navigate} />
        <Toaster />
      </div>
    </ThemeProvider>
  )
}









